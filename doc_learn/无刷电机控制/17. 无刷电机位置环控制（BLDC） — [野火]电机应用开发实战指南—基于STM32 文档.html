<!DOCTYPE html>
<!-- saved from url=(0096)https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html -->
<html class="writer-html5" lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
<title>17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32  文档</title>
<link rel="shortcut icon" type="image/x-icon" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/_static/images/logo.ico">


  
  <link rel="stylesheet" href="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/theme.css" type="text/css">
  <link rel="stylesheet" href="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/pygments.css" type="text/css">
  <link rel="stylesheet" href="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/custom.css" type="text/css">

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/documentation_options.js.下载"></script>
        <script src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/jquery.js.下载"></script>
        <script src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/underscore.js.下载"></script>
        <script src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/doctools.js.下载"></script>
        <script src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/language_data.js.下载"></script>
        <script src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/translations.js.下载"></script>
    
    <script type="text/javascript" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/theme.js.下载"></script>

    
    <link rel="index" title="索引" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/genindex.html">
    <link rel="search" title="搜索" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/search.html">
    <link rel="next" title="18. 无刷电机双环控制（BLDC）" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_multi_loop_control.html">
    <link rel="prev" title="16. 无刷电机速度环控制（BLDC）" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_speed_loop_control.html"> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
<!-------------------------------------------------------------------------------------------------------------------------------->
<a href="https://embedfire.com/"><img alt="embedfire" title="官网" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/embedfire.png"></a>
&nbsp;<a href="https://www.firebbs.cn/"><img alt="firebbs" title="论坛" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/firebbs.png"></a>
&nbsp;<a href="https://gitee.com/Embedfire-motor/ebf_motor_tutorial_code_stm32f407_jiaoyang"><img alt="gitee" title="gitee" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/gitee.png"></a>
&nbsp;<a href="https://github.com/Embedfire"><img alt="github" title="github" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/github.png"></a>
<!-------------------------------------------------------------------------------------------------------------------------------->

<a href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/index.html">
  <img src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/logo-1.png" style="margin-top: -20px;" class="logo" alt="Logo">
  [野火]电机应用开发实战指南—基于STM32
</a>



  
  
    <!--<div class="version">
      fee1432
    </div>-->
  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
</div>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">关于本项目</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/README.html">关于本项目</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/about_us.html">关于野火</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/contribute/quick-contribute.html">快速参与本项目（提交bug或文档修改）</a></li>
</ul>
<p class="caption"><span class="caption-text">如何学习</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/zero_part/foreword.html">1. 前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/zero_part/why-study.html">2. 为什么学习电机应用开发？</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/zero_part/how-study.html">3. 如何学习电机应用开发？</a></li>
</ul>
<p class="caption"><span class="caption-text">基础部分</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/motor_introduction.html">1. 电机的分类介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/classification_of_drives.html">2. 驱动器的分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/stm32_time_detailed.html">3. stm32定时器详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/DC_brushed_motor.html">4. 直流有刷电机</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/brushed_current_vbus_gather.html">5. 直流有刷驱动板电流电压采集</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/steering_gear_control.html">6. 舵机控制</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/stepper_motor.html">7. 步进电机</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/brushless_DC_motor.html">8. 无刷直流电机</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/brushless_temp_vbus_gather.html">9. 直流无刷驱动板温度电压采集</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/brushless_temp_vbus_triphase_current.html">10. 无刷有刷驱动板温度电压三相电流采集</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/basis_part/detailed_encoder.html">11. 编码器详解</a></li>
</ul>
<p class="caption"><span class="caption-text">提高部分</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/relationship_between_control_system_and_motor.html">1. 控制系统与电机的关系</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/PID_detailed.html">2. PID算法的通俗解说</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/PID_parameter_tuning.html">3. PID控制器参数整定</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/use_of_encoder.html">4. 编码器的使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/dc_motor_speed_loop_control.html">5. 直流电机速度环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/dc_motor_current_loop_control.html">6. 直流电机电流环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/dc_motor_pos_loop_control.html">7. 直流电机位置环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/dc_motor_multi_loop_control.html">8. 有刷电机多环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_speed_loop_control.html">9. 步进电机速度环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_pos_loop_control.html">10. 步进电机位置环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_double_loop_control.html">11. 步进电机位置速度双环控制实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_T_speed.html">12. 步进电机梯形加减速实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_S_speed.html">13. 步进电机S形加减速实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_linear_interpolation.html">14. 步进电机直线插补实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/step_motor_circular_interpolation.html">15. 步进电机圆弧插补实现</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_speed_loop_control.html">16. 无刷电机速度环控制（BLDC）</a></li>
<li class="toctree-l1 current"><a class="reference internal current" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#"><span class="toctree-expand"></span>17. 无刷电机位置环控制（BLDC）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id1">17.1. 硬件设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#pid"><span class="toctree-expand"></span>17.2. 直流无刷电机位置环控制-位置式PID实现</a><ul>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id2"><span class="toctree-expand"></span>17.2.1. 软件设计1</a><ul>
<li class="toctree-l4"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id3">17.2.1.1. 编程要点1</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id4">17.2.2. 软件分析1</a></li>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id5">17.2.3. 下载验证1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id6"><span class="toctree-expand"></span>17.3. 直流无刷电机位置环控制-增量式PID实现</a><ul>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id7"><span class="toctree-expand"></span>17.3.1. 软件设计2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id8">17.3.1.1. 编程要点2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id9">17.3.2. 软件分析2</a></li>
<li class="toctree-l3"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id10">17.3.3. 下载验证2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_multi_loop_control.html">18. 无刷电机双环控制（BLDC）</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/ST-FOC-MC_SDK5x-overview.html">19. ST FOC MC SDK5.x电机控制软件框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/X-CUBE-MCSDK_installation_use.html">20. X-CUBE-MCSDK——安装与使用</a></li>
</ul>
<p class="caption"><span class="caption-text">电机使用常见问题说明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/zero_part/motor_direction_use.html">电机使用常见问题说明</a></li>
</ul>
<p class="caption"><span class="caption-text">版权</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/LICENSE.html">版权说明</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/index.html">[野火]电机应用开发实战指南—基于STM32</a>
        
      </nav>


      <div class="wy-nav-content">
<style>

    @media screen and (max-width: 1100px){
        .prodcut-show-main{
            display: none;
        }
    }
    .prodcut-show-main{
        background: #edf0f2;
        width: 100%;
        height: 170px;
        margin-bottom: 24px;
    }
    .prodcut-show-main .prodcut-show-main-left{
        width: 33%;
    }
    .prodcut-show-main .prodcut-show-main-right{
        width: 64%;
        margin-top: 13px;
        margin-right: 18px;
    }
    .prodcut-show-main .prodcut-show-main-right p{
        color: gray;
        font-size: 84%;
        height: 74px;
        overflow-x: hidden;
    }
    .product-show-name .fa-pull-left{
        
        font-size: 124%;
        color: #0077ff;
        font-weight: bolder;
        
    }
    .product-show-name{
        margin-bottom: 12px;
    }
    .fa-pull-right a{
        
        background: #0077ff;
        color: white;
        padding: 6px 16px;
        border-radius: 4px;
        font-size: 80%;
        margin-right: 10px;

    }
    .prodcut-show-img{
        height: 170px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
</style>

<div class="prodcut-show-main clearfix">
    <div class="fa-pull-left prodcut-show-main-left">
        <div class="prodcut-show-img">
        <!------------------------------------------------------------------------------------------------------>
        <div align="center">
            <img alt="产品图片" height="80%" width="80%" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/f407fuxiao.jpg">
        </div>
        <!------------------------------------------------------------------------------------------------------>
        </div>
    </div>
    <div class="fa-pull-right prodcut-show-main-right">
        <div class="product-show-name clearfix">
            <div class="fa-pull-left ">
                <!-------------------------------------------------------->
                F103拂晓/F407骄阳/H743繁星 电机开发板 <span></span>
                <!-------------------------------------------------------->
            </div>
        </div>

        <div class="fa-pull-left">
            <!-------------------------------------------------------------------------------------------------------------------------------->
            <a href="https://doc.embedfire.com/motor/motor_tutorial/pdf/index.html" target="_blank">PDF文档 </a>
            
            <a href="https://gitee.com/Embedfire-motor/ebf_motor_tutorial_code_stm32f407_jiaoyang" target="_blank">配套程序</a>
            
            <a href="https://www.bilibili.com/video/BV1AZ4y1V7wt" target="_blank">配套视频</a>

            <a href="https://m.tb.cn/h.45EHh51?sm=4e48c8" target="_blank">立即购买</a>
            <!-------------------------------------------------------------------------------------------------------------------------------->
            
        </div>
        <br>
        <br>
        <!-------------------------------------------------------------------------------------------------------------------------------->
        <p>F407骄阳电机开发板是野火电子推出的电机控制主板系列，整板硬件资源非常丰富，2个直流有刷/无刷电机接口、4个步进电机接口、2个舵机接口6路模拟输入接口、3个4路隔离输入接口、1个4路隔离输出接口、1个编码器输入接口、1路CAN、1路485、1路MAX232、EEPROM、SPI FLASH、以太网、USB HOST、USB转串口、RTC座、SWD下载调试接口、LCD接口、串口屏接口，硬件资源丰富全面是一款全功能的学习评估板。板上多种输入输出IO全部隔离，可作为企业产品批量使用。并且野火提供丰富的学习资料和开发板例程，适合新手入门学习使用。</p>
        <!-------------------------------------------------------------------------------------------------------------------------------->
    </div>
</div>


<div class="rst-content">

  















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/index.html" class="icon icon-home"></a> »</li>
        
      <li><span class="section-number">17. </span>无刷电机位置环控制（BLDC）</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr>
</div>
  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
   <div itemprop="articleBody">
    
  <div class="section" id="bldc">
<h1><span class="section-number">17. </span>无刷电机位置环控制（BLDC）<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#bldc" title="永久链接至标题">¶</a></h1>
<p>承接上一章节的直流无刷电机速度环PID控制。
电机控制除了速度之外，另一种常见的应用就是对于电机旋转位置的控制。
本章节中我们就通过位置环的PID控制来实现直流无刷电机的位置控制。</p>
<p>本章通过我们前面学习的位置式PID和增量式PID两种控制方式分别来实现位置环的控制，
如果还不知道什么是位置式PID和增量式PID，请务必先学习前面PID算法的通俗解说这一章节。</p>
<div class="section" id="id1">
<h2><span class="section-number">17.1. </span>硬件设计<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id1" title="永久链接至标题">¶</a></h2>
<p>关于详细的硬件分析在直流无刷电机章节中已经讲解过，这里不再做分析，
如有不明白请参考前面章节，这里只给出接线表。</p>
<p>电机主控板与无刷电机驱动板连接见下表所示。</p>
<div class="wy-table-responsive"><table class="colwidths-given docutils align-center" id="id11">
<caption><span class="caption-text">电机与无刷电机驱动板连接</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id11" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>电机</p></th>
<th class="head"><p>无刷电机驱动板</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>粗黄</p></td>
<td><p>U</p></td>
</tr>
<tr class="row-odd"><td><p>粗绿</p></td>
<td><p>V</p></td>
</tr>
<tr class="row-even"><td><p>粗蓝</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>细红</p></td>
<td><p>+（编码器电源）</p></td>
</tr>
<tr class="row-even"><td><p>细黑</p></td>
<td><p>-（编码器电源）</p></td>
</tr>
<tr class="row-odd"><td><p>细黄</p></td>
<td><p>HIU</p></td>
</tr>
<tr class="row-even"><td><p>细绿</p></td>
<td><p>HIV</p></td>
</tr>
<tr class="row-odd"><td><p>细蓝</p></td>
<td><p>HIW</p></td>
</tr>
</tbody>
</table></div>
<p>无刷电机驱动板与主控板连接见下表所示。</p>
<div class="wy-table-responsive"><table class="colwidths-given docutils align-center" id="id12">
<caption><span class="caption-text">无刷电机驱动板与主控板连接</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id12" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>无刷电机驱动板</p></th>
<th class="head"><p>主控板</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>5V_IN</p></td>
<td><p>5V</p></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p>GND</p></td>
</tr>
<tr class="row-even"><td><p>U+</p></td>
<td><p>PI5</p></td>
</tr>
<tr class="row-odd"><td><p>U-</p></td>
<td><p>PH13</p></td>
</tr>
<tr class="row-even"><td><p>V+</p></td>
<td><p>PI6</p></td>
</tr>
<tr class="row-odd"><td><p>V-</p></td>
<td><p>PH14</p></td>
</tr>
<tr class="row-even"><td><p>W+</p></td>
<td><p>PI7</p></td>
</tr>
<tr class="row-odd"><td><p>W-</p></td>
<td><p>PH15</p></td>
</tr>
<tr class="row-even"><td><p>HU</p></td>
<td><p>PH10</p></td>
</tr>
<tr class="row-odd"><td><p>HV</p></td>
<td><p>PH11</p></td>
</tr>
<tr class="row-even"><td><p>HW</p></td>
<td><p>PH12</p></td>
</tr>
<tr class="row-odd"><td><p>SD</p></td>
<td><p>PE6</p></td>
</tr>
</tbody>
</table></div>
<p>推荐使用配套的牛角排线直接连接驱动板和主控板。连接开发板的那端，请连接在“无刷电机驱动接口2”上。</p>
</div>
<div class="section" id="pid">
<h2><span class="section-number">17.2. </span>直流无刷电机位置环控制-位置式PID实现<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#pid" title="永久链接至标题">¶</a></h2>
<div class="section" id="id2">
<h3><span class="section-number">17.2.1. </span>软件设计1<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id2" title="永久链接至标题">¶</a></h3>
<p>这里只讲解核心的部分代码，有些变量的设置，头文件的包含等并没有涉及到，
还有一些在前章节章节分析过的代码在这里也不在重复讲解，完整的代码请参考本章配套的工程。
本章代码在野火电机驱动例程中:\base_code\improve_part\F407\直流无刷电机-速度环控制-位置式PID目录下。</p>
<div class="section" id="id3">
<h4><span class="section-number">17.2.1.1. </span>编程要点1<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id3" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>高级定时器 IO 配置</p></li>
<li><p>定时器时基结构体TIM_HandleTypeDef配置</p></li>
<li><p>定时器输出比较结构体TIM_OC_InitTypeDef配置</p></li>
<li><p>根据电机的换相表编写换相中断回调函数</p></li>
<li><p>根据定时器定义电机控制相关函数.</p></li>
<li><p>配置基本定时器可以产生定时中断来执行PID运算</p></li>
<li><p>编写位置式PID算法</p></li>
<li><p>编写位置控制函数</p></li>
<li><p>增加上位机曲线观察相关代码</p></li>
<li><p>编写按键控制代码</p></li>
</ol>
</div>
</div>
<div class="section" id="id4">
<h3><span class="section-number">17.2.2. </span>软件分析1<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id4" title="永久链接至标题">¶</a></h3>
<p>在编程要点中的与上一章节重复的部分，这里就不在详细讲解，
如果不明白请先学习前面相关章节的内容。这里主要讲解位置的获取方法和分析PID算法的控制实现部分。</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">bsp_motor_tim.c-设置pwm输出的占空比</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id13" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">set_pwm_pulse</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">pulse</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="cm">/* 设置定时器通道输出 PWM 的占空比 */</span>
   <span class="n">bldcm_pulse</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">motor_drive</span><span class="p">.</span><span class="n">enable_flag</span><span class="p">)</span>
     <span class="n">HAL_TIM_TriggerCallback</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>   <span class="c1">// 执行一次换相</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>该函数用于设置pwm输出的占空比，本函数只是将占空比存放在了bldcm_pulse变量中，
而真正设置正空比是在HAL_TIM_TriggerCallback()函数中，
所以在电机使能时需要调用HAL_TIM_TriggerCallback()设置pwm输出的占空比。</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">bsp_motor_tim.c-更新电机速度</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id14" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">static</span> <span class="kt">void</span> <span class="n">update_motor_speed</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">dir_in</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">time</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="kt">int</span> <span class="n">speed_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">float</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="cm">/* 计算速度：</span>
<span class="cm">     电机每转一圈共用12个脉冲，(1.0/(84000000.0/128.0)为计数器的周期，(1.0/(84000000.0/128.0) * time)为时间长。</span>
<span class="cm">   */</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed_group</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">else</span>
   <span class="p">{</span>
     <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0f</span> <span class="o">/</span> <span class="p">(</span><span class="mf">84000000.0f</span> <span class="o">/</span> <span class="n">HALL_PRESCALER_COUNT</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="p">);</span>
     <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0f</span> <span class="o">/</span> <span class="mf">12.0f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span>  <span class="o">/</span> <span class="mf">60.0f</span><span class="p">);</span>
     <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed_group</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">update_speed_dir</span><span class="p">(</span><span class="n">dir_in</span><span class="p">);</span>
   <span class="c1">//        motor_drive.speed = motor_drive.speed_group[count-1];</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">SPEED_FILTER_NUM</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
     <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="c1">//        return ;</span>
   <span class="n">speed_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="cm">/* 计算近 SPEED_FILTER_NUM 次的速度平均值（滤波） */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">SPEED_FILTER_NUM</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
     <span class="p">{</span>
       <span class="n">speed_temp</span> <span class="o">+=</span> <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed_group</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
     <span class="p">}</span>

     <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed_temp</span><span class="o">/</span> <span class="n">SPEED_FILTER_NUM</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
     <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
     <span class="p">{</span>
       <span class="n">speed_temp</span> <span class="o">+=</span> <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed_group</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
     <span class="p">}</span>

     <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed_temp</span> <span class="o">/</span> <span class="n">count</span><span class="p">;</span>
   <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>该函数用于更新电机的当前速度，其中形参time传入的是霍尔传感器有变化时定时器捕获到的值，
通过time就可以计算出一次换相的时间为(1.0/(84000000.0/128.0) * time)秒，电机旋转一圈共有12个变化信号，
所以电机的速度为：(1.0 / 12.0) / ((1.0 / (84000000.0 / HALL_PRESCALER_COUNT) * time) / 60.0)RPM。
将计算得到的速度保存在motor_drive.speed_group[]数组中，计算最近SPEED_FILTER_NUM次的速度值，达到滤波的效果，
最后调用update_speed_dir()更新速度方向。</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">bsp_motor_tim.c-更新电机速度方向与位置</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id15" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">static</span> <span class="kt">void</span> <span class="n">update_speed_location_dir</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">dir_in</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">step</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>

    <span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">num_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">step_loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// 用于记录当前霍尔位置</span>
    <span class="kt">int8_t</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">step_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">step_loc</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">step_loc</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="n">step_loc</span><span class="p">]</span> <span class="o">==</span> <span class="n">dir_in</span><span class="p">)</span>    <span class="c1">// 找到当前霍尔的位置</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* 端点处理 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">step_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_old</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_old</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">dir</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* 端点处理 */</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">step_loc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_old</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_old</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">dir</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">step_loc</span> <span class="o">&gt;</span> <span class="n">num_old</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">dir</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">step_loc</span> <span class="o">&lt;</span> <span class="n">num_old</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">num_old</span> <span class="o">=</span> <span class="n">step_loc</span><span class="p">;</span>
    <span class="n">motor_drive</span><span class="p">.</span><span class="n">speed_group</span><span class="p">[</span><span class="n">count</span><span class="mi">-1</span><span class="p">]</span><span class="o">*=</span> <span class="n">dir</span><span class="p">;</span>
    <span class="n">motor_drive</span><span class="p">.</span><span class="n">location</span> <span class="o">+=</span> <span class="n">dir</span><span class="p">;</span>    <span class="c1">// 更新位置</span>
  <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>该函数用于更新电机的速度方向，使用当前读到的霍尔值，与上一次读到的霍尔值进行对比，来确定方向。
另外，根据当前的确定方向，进行位置的更新计数</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">bsp_motor_tim.c-换相实现函数</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id16" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="nf">HAL_TIM_TriggerCallback</span><span class="p">(</span><span class="n">TIM_HandleTypeDef</span> <span class="o">*</span><span class="n">htim</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* 获取霍尔传感器引脚状态,作为换相的依据 */</span>
    <span class="kt">uint8_t</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">step</span> <span class="o">=</span> <span class="n">get_hall_state</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">htim</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">htimx_hall</span><span class="p">)</span>   <span class="c1">// 判断是否由触发中断产生</span>
    <span class="p">{</span>
      <span class="n">update_motor_speed</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">__HAL_TIM_GET_COMPARE</span><span class="p">(</span><span class="n">htim</span><span class="p">,</span><span class="n">TIM_CHANNEL_1</span><span class="p">));</span>
      <span class="n">motor_drive</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">get_bldcm_direction</span><span class="p">()</span> <span class="o">==</span> <span class="n">MOTOR_FWD</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>    <span class="cm">/* U+ W- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 2 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 1 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>     <span class="cm">/* V+ U- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 3 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 2 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>

            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>    <span class="cm">/* V+ W- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 2 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>     <span class="cm">/* W+ V- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 3 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>     <span class="cm">/* U+  V -*/</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 3 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 1 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>     <span class="cm">/* W+ U- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 2 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 3 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>   <span class="cm">/* W+ U- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 2 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 3 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>    <span class="cm">/* U+  V -*/</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 3 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 1 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>   <span class="cm">/* W+ V- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 3 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>

            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>    <span class="cm">/* V+ W- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 2 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>    <span class="cm">/* V+ U- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 3 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 2 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>

          <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>    <span class="cm">/* U+ W- */</span>
            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 2 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM2_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM2_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                            <span class="c1">// 通道 1 配置为 0</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM1_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM1_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_RESET</span><span class="p">);</span>    <span class="c1">// 关闭下桥臂</span>

            <span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">,</span> <span class="n">bldcm_pulse</span><span class="p">);</span>                  <span class="c1">// 通道 1 配置的占空比</span>
            <span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">MOTOR_OCNPWM3_GPIO_PORT</span><span class="p">,</span> <span class="n">MOTOR_OCNPWM3_PIN</span><span class="p">,</span> <span class="n">GPIO_PIN_SET</span><span class="p">);</span>      <span class="c1">// 开启下桥臂</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

    <span class="n">HAL_TIM_GenerateEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htimx_bldcm</span><span class="p">,</span> <span class="n">TIM_EVENTSOURCE_COM</span><span class="p">);</span>    <span class="c1">// 软件产生换相事件，此时才将配置写入</span>
  <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>换相的实现在直流无刷电机章节已经讲过这个不在赘述，在上面第7行的**if**里面判断了htim和&amp;htimx_hall是否相等，
如果是则说明是中断产生而回调的，更新速度和检测堵转超时，如果不相等则说明是第一次启动或设置占空比时调用，
不更新速度和检测堵转超时的变量。</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">bsp_basic_tim.h-宏定义</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id17" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="cp">#define BASIC_TIM                             TIM6</span>
 <span class="cp">#define BASIC_TIM_CLK_ENABLE()      __TIM6_CLK_ENABLE()</span>

 <span class="cp">#define BASIC_TIM_IRQn                                  TIM6_DAC_IRQn</span>
 <span class="cp">#define BASIC_TIM_IRQHandler        TIM6_DAC_IRQHandler</span>

 <span class="cm">/* 累计 TIM_Period个后产生一个更新或者中断*/</span>
   <span class="c1">//当定时器从0计数到BASIC_PERIOD_COUNT-1，即为BASIC_PERIOD_COUNT次，为一个定时周期</span>
 <span class="cp">#define BASIC_PERIOD_COUNT    (50*20)</span>

 <span class="c1">//定时器时钟源TIMxCLK = 2 * PCLK1</span>
 <span class="c1">//                          PCLK1 = HCLK / 4</span>
 <span class="c1">//                          =&gt; TIMxCLK=HCLK/2=SystemCoreClock/2=84MHz</span>
 <span class="cp">#define BASIC_PRESCALER_COUNT   (1680)</span>

 <span class="cm">/* 获取定时器的周期，单位ms */</span>
 <span class="c1">//#define __HAL_TIM_GET_PRESCALER(__HANDLE__)      ((__HANDLE__)-&gt;Instance-&gt;PSC)    // Get TIM Prescaler.</span>
 <span class="c1">//#define GET_BASIC_TIM_PERIOD(__HANDLE__)    (1.0/(HAL_RCC_GetPCLK2Freq()/(__HAL_TIM_GET_PRESCALER(__HANDLE__)+1)/(__HAL_TIM_GET_AUTORELOAD(__HANDLE__)+1))*1000)</span>

 <span class="cm">/* 以下两宏仅适用于定时器时钟源TIMxCLK=84MHz，预分频器为：1680-1 的情况 */</span>
 <span class="cp">#define SET_BASIC_TIM_PERIOD(T)     __HAL_TIM_SET_AUTORELOAD(&amp;TIM_TimeBaseStructure, (T)*50 - 1)    </span><span class="c1">// 设置定时器的周期（1~1000ms）</span>
 <span class="cp">#define GET_BASIC_TIM_PERIOD()      ((__HAL_TIM_GET_AUTORELOAD(&amp;TIM_TimeBaseStructure)+1)/50.0)     </span><span class="c1">// 获取定时器的周期，单位ms</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>这里封装了定时器的一些相关的宏，使用宏定义非常方便程序升级、移植。使用SET_BASIC_TIM_PERIOD(T)这个宏可以设置定时器的周期，
这样可以通过按键或者上位机来设置这个定时器的中断周期，使用GET_BASIC_TIM_PERIOD()这个宏可以得到定时器的当前周期，
不过使用的两个宏是有要求的，需要定时器时钟源的频率是84MHz，且预分频系数为1680。
如果更换定时器和修改预分频器则需要重新计算这个宏里面的参数.我们来看一下当前宏中周期的计算:84000000/1680/20 = 2500,
84000000为时钟源的频率，1680为预分频系数，50为自动重装载值，1000为定时器产生更新中断的频率，
当定时器以(84000000/1680)Hz的频率计数到50时刚好是1ms，所以只要设置自动重装载值为50的n倍减一时，
就可以得到n毫秒的更新中断，注意n是1到1000的正整数。</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">bsp_basic_tim.c-定时器配置函数</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id18" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">static</span> <span class="kt">void</span> <span class="n">TIM_Mode_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="c1">// 开启TIMx_CLK,x[6,7]</span>
   <span class="n">BASIC_TIM_CLK_ENABLE</span><span class="p">();</span>

   <span class="n">TIM_TimeBaseStructure</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">BASIC_TIM</span><span class="p">;</span>
   <span class="cm">/* 累计 TIM_Period个后产生一个更新或者中断*/</span>
   <span class="c1">//当定时器从0计数到BASIC_PERIOD_COUNT-1，即为BASIC_PERIOD_COUNT次，为一个定时周期</span>
   <span class="n">TIM_TimeBaseStructure</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span> <span class="o">=</span> <span class="n">BASIC_PERIOD_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

   <span class="c1">//定时器时钟源TIMxCLK = 2 * PCLK1</span>
   <span class="c1">//                                PCLK1 = HCLK / 4</span>
   <span class="c1">//                                =&gt; TIMxCLK=HCLK/2=SystemCoreClock/2=84MHz</span>
   <span class="c1">// 设定定时器频率为=TIMxCLK/BASIC_PRESCALER_COUNT</span>
   <span class="n">TIM_TimeBaseStructure</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Prescaler</span> <span class="o">=</span> <span class="n">BASIC_PRESCALER_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">TIM_TimeBaseStructure</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">CounterMode</span> <span class="o">=</span> <span class="n">TIM_COUNTERMODE_UP</span><span class="p">;</span>           <span class="c1">// 向上计数</span>
   <span class="n">TIM_TimeBaseStructure</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">ClockDivision</span> <span class="o">=</span> <span class="n">TIM_CLOCKDIVISION_DIV1</span><span class="p">;</span>     <span class="c1">// 时钟分频</span>

   <span class="c1">// 初始化定时器TIMx, x[2,3,4,5]</span>
   <span class="n">HAL_TIM_Base_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TIM_TimeBaseStructure</span><span class="p">);</span>

   <span class="c1">// 开启定时器更新中断</span>
   <span class="n">HAL_TIM_Base_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TIM_TimeBaseStructure</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>首先定义两个定时器初始化结构体，定时器模式配置函数主要就是对这两个结构体的成员进行初始化，
然后通过调用的初始化函数HAL_TIM_Base_Init()把这些参数写入定时器的寄存器中。
有关结构体的成员介绍请参考定时器详解章节。
最后通过调用函数HAL_TIM_Base_Start_IT()使能定时器的更新中断。</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">bsp_basic_tim.c-定时器初始</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id19" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">TIMx_Configuration</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="n">TIMx_NVIC_Configuration</span><span class="p">();</span>

   <span class="n">TIM_Mode_Config</span><span class="p">();</span>

 <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
   <span class="kt">uint32_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">GET_BASIC_TIM_PERIOD</span><span class="p">();</span>     <span class="c1">// 计算周期，单位ms</span>

   <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEED_PERIOD_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送目标值</span>
 <span class="cp">#endif</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>该函数主要配置了定时器的中断设置和定时器模式配置，最后调用set_computer_value()函数设置了上位机的周期值，
这里只是同步一下上位机显示的周期值。PID_ASSISTANT_EN是用于选择是否使用上位机的宏，
当我们在调试阶段时可以定义这个宏，方便使用上位机（野火调试助手-PID调试助手）来观察电机的运行效果，
在完成调试后我们可以直接不定义这个宏，这样就去掉了上位机相关部分。</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">bsp_pid.c-位置式PID参数初始化</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id20" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">PID_param_init</span><span class="p">()</span>
 <span class="p">{</span>
   <span class="cm">/* 初始化参数 */</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">target_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">integral</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>

   <span class="n">pid</span><span class="p">.</span><span class="n">Kp</span> <span class="o">=</span> <span class="mi">124</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>

 <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
   <span class="kt">float</span> <span class="n">pid_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">.</span><span class="n">Kp</span><span class="p">,</span> <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span><span class="p">,</span> <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span><span class="p">};</span>
   <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_P_I_D_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="n">pid_temp</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送 P I D 值</span>
 <span class="cp">#endif</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>PID_param_init()函数把结构体pid参数初始化，将目标、实际值、偏差值和积分项等初始化为0，
其中pid.Kp、pid.Ki和pid.Kd是我们配套电机运行效果相对比较好的参数，不同的电机该参数是不同的。
set_computer_value()函数用来同步上位机显示的PID值。</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">bsp_pid.c-设置速度目标值</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id21" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">set_pid_target</span><span class="p">(</span><span class="kt">float</span> <span class="n">temp_val</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">target_val</span> <span class="o">=</span> <span class="n">temp_val</span><span class="p">;</span>    <span class="c1">// 设置当前的目标值</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>设置目标值</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">bsp_pid.c-位置式PID算法实现</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id22" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">float</span> <span class="nf">PID_realize</span><span class="p">(</span><span class="kt">float</span> <span class="n">actual_val</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="cm">/*计算目标值与实际值的误差*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">target_val</span> <span class="o">-</span> <span class="n">actual_val</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">integral</span> <span class="o">+=</span> <span class="n">pid</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>

   <span class="cm">/*PID算法实现*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">Kp</span> <span class="o">*</span> <span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">+</span>
                    <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span> <span class="o">*</span> <span class="n">pid</span><span class="p">.</span><span class="n">integral</span> <span class="o">+</span>
                    <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">-</span> <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span><span class="p">);</span>

   <span class="cm">/*误差传递*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>

   <span class="cm">/*返回当前实际值*/</span>
   <span class="k">return</span> <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>这个函数主要实现了位置式PID算法，用传入的目标值减去实际值得到误差值得到比例项，在对误差值进行累加得到积分项，
用本次误差减去上次的误差得到微分项，然后通过前面章节介绍的位置式PID公式实现PID算法，并返回实际控制值。</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">bsp_bldcm_control-电机位置式PID算法实现</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id23" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">bldcm_pid_control</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="kt">int32_t</span> <span class="n">location_actual</span> <span class="o">=</span> <span class="n">get_motor_location</span><span class="p">();</span>   <span class="c1">// 电机旋转的当前位置</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">bldcm_data</span><span class="p">.</span><span class="n">is_enable</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="kt">float</span> <span class="n">cont_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// 当前控制值</span>

     <span class="n">cont_val</span> <span class="o">=</span> <span class="n">PID_realize</span><span class="p">(</span><span class="n">location_actual</span><span class="p">);</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">cont_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">cont_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">cont_val</span><span class="p">;</span>
         <span class="n">bldcm_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">MOTOR_REV</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">else</span>
     <span class="p">{</span>
         <span class="n">bldcm_data</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">MOTOR_FWD</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="n">cont_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">cont_val</span> <span class="o">&gt;</span> <span class="n">PWM_PERIOD_COUNT</span><span class="p">)</span> <span class="o">?</span> <span class="nl">PWM_PERIOD_COUNT</span> <span class="p">:</span> <span class="n">cont_val</span><span class="p">;</span>  <span class="c1">// 上限处理</span>

     <span class="n">set_bldcm_speed</span><span class="p">(</span><span class="n">cont_val</span><span class="p">);</span>

   <span class="cp">#ifdef PID_ASSISTANT_EN</span>
     <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_FACT_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">location_actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送实际值</span>
   <span class="cp">#else</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"实际值：%d, 目标值： %.0f，控制值: %.0f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">location_actual</span><span class="p">,</span> <span class="n">get_pid_target</span><span class="p">(),</span> <span class="n">cont_val</span><span class="p">);</span>
   <span class="cp">#endif</span>
   <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>该函数在定时器的中断里定时调用默认是20毫秒调用一次，如果改变了周期那么PID三个参数也需要做相应的调整，
PID的控制周期与控制效果是息息相关的。
调用get_motor_location()获取电机的旋转位置，单位是多少个控制信号，一个控制信号代表30°。把实际速度带入PID_realize(speed_actual)进行运算，
根据运算结果的正负，设置电机的旋转方向。
最后对输出的结果做一个上限处理，最后用于PWM占空比的控制，最后将实际的速度值发送到上位机绘制变化的曲线。</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">protocol.c-串口数据解析</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id24" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="cm">/**</span>
<span class="cm">  * @brief   接收的数据处理</span>
<span class="cm">  * @param   void</span>
<span class="cm">  * @return  -1：没有找到一个正确的命令.</span>
<span class="cm">  */</span>
  <span class="kt">int8_t</span> <span class="nf">receiving_process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">frame_data</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>         <span class="c1">// 要能放下最长的帧</span>
    <span class="kt">uint16_t</span> <span class="n">frame_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// 帧长度</span>
    <span class="kt">uint8_t</span> <span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_NONE</span><span class="p">;</span>     <span class="c1">// 命令类型</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">cmd_type</span> <span class="o">=</span> <span class="n">protocol_frame_parse</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame_len</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">cmd_type</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="nl">CMD_NONE</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">case</span> <span class="nl">SET_P_I_D_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="kt">uint32_t</span> <span class="n">temp0</span> <span class="o">=</span> <span class="n">COMPOUND_32BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
          <span class="kt">uint32_t</span> <span class="n">temp1</span> <span class="o">=</span> <span class="n">COMPOUND_32BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_data</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
          <span class="kt">uint32_t</span> <span class="n">temp2</span> <span class="o">=</span> <span class="n">COMPOUND_32BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_data</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>

          <span class="kt">float</span> <span class="n">p_temp</span><span class="p">,</span> <span class="n">i_temp</span><span class="p">,</span> <span class="n">d_temp</span><span class="p">;</span>

          <span class="n">p_temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp0</span><span class="p">;</span>
          <span class="n">i_temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp1</span><span class="p">;</span>
          <span class="n">d_temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp2</span><span class="p">;</span>

          <span class="n">set_p_i_d</span><span class="p">(</span><span class="n">p_temp</span><span class="p">,</span> <span class="n">i_temp</span><span class="p">,</span> <span class="n">d_temp</span><span class="p">);</span>    <span class="c1">// 设置 P I D</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">SET_TARGET_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="kt">int</span> <span class="n">actual_temp</span> <span class="o">=</span> <span class="n">COMPOUND_32BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>    <span class="c1">// 得到数据</span>

          <span class="n">set_pid_target</span><span class="p">(</span><span class="n">actual_temp</span><span class="p">);</span>    <span class="c1">// 设置目标值</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">START_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="n">set_bldcm_enable</span><span class="p">();</span>              <span class="c1">// 启动电机</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">STOP_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="n">set_bldcm_disable</span><span class="p">();</span>              <span class="c1">// 停止电机</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">RESET_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="n">HAL_NVIC_SystemReset</span><span class="p">();</span>          <span class="c1">// 复位系统</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">SET_PERIOD_CMD</span><span class="p">:</span>
        <span class="p">{</span>
          <span class="kt">uint32_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">COMPOUND_32BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>     <span class="c1">// 周期数</span>
          <span class="n">SET_BASIC_TIM_PERIOD</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>                             <span class="c1">// 设置定时器周期1~1000ms</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
          <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>这函数用于处理上位机发下的数据，在主函数中循环调用，可以使用上位机调整PID参数，使用上位机可以非常方便的调整PID参数，
这样可以不用每次修改PID参数时都要改代码、编译和下载代码；可以使用上位机设置目标速度；可以启动和停止电机；
可以使用上位机复位系统；可以使用上位机设置定时器的周期；具体功能的实现请参考配套工程代码。</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">main.c-主函数</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id25" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">int32_t</span> <span class="n">target_location</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

      <span class="cm">/* 初始化系统时钟为168MHz */</span>
      <span class="n">SystemClock_Config</span><span class="p">();</span>

      <span class="cm">/* HAL 库初始化 */</span>
      <span class="n">HAL_Init</span><span class="p">();</span>

      <span class="cm">/* 初始化按键GPIO */</span>
      <span class="n">Key_GPIO_Config</span><span class="p">();</span>

      <span class="cm">/* LED 灯初始化 */</span>
      <span class="n">LED_GPIO_Config</span><span class="p">();</span>

      <span class="cm">/* 协议初始化 */</span>
      <span class="n">protocol_init</span><span class="p">();</span>

      <span class="cm">/* 调试串口初始化 */</span>
      <span class="n">DEBUG_USART_Config</span><span class="p">();</span>

      <span class="n">PID_param_init</span><span class="p">();</span>

      <span class="cm">/* 周期控制定时器 50ms */</span>
      <span class="n">TIMx_Configuration</span><span class="p">();</span>

      <span class="cm">/* 电机初始化 */</span>
      <span class="n">bldcm_init</span><span class="p">();</span>

      <span class="cm">/* 设置目标位置 */</span>
      <span class="n">set_pid_target</span><span class="p">(</span><span class="n">target_location</span><span class="p">);</span>

    <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
      <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_STOP_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                <span class="c1">// 同步上位机的启动按钮状态</span>
      <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_TARGET_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_location</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送目标值</span>
    <span class="cp">#endif</span>

      <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/* 接收数据处理 */</span>
        <span class="n">receiving_process</span><span class="p">();</span>

        <span class="cm">/* 扫描KEY1 */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">Key_Scan</span><span class="p">(</span><span class="n">KEY1_GPIO_PORT</span><span class="p">,</span><span class="n">KEY1_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_ON</span>  <span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* 使能电机 */</span>
          <span class="n">set_bldcm_enable</span><span class="p">();</span>

        <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
          <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_START_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>               <span class="c1">// 同步上位机的启动按钮状态</span>
        <span class="cp">#endif</span>
        <span class="p">}</span>

        <span class="cm">/* 扫描KEY2 */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">Key_Scan</span><span class="p">(</span><span class="n">KEY2_GPIO_PORT</span><span class="p">,</span><span class="n">KEY2_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_ON</span>  <span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* 停止电机 */</span>
          <span class="n">set_bldcm_disable</span><span class="p">();</span>

        <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
          <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_STOP_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>               <span class="c1">// 同步上位机的启动按钮状态</span>
        <span class="cp">#endif</span>
        <span class="p">}</span>

        <span class="cm">/* 扫描KEY3 */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">Key_Scan</span><span class="p">(</span><span class="n">KEY3_GPIO_PORT</span><span class="p">,</span><span class="n">KEY3_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_ON</span>  <span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* 增大占空比 */</span>
          <span class="n">target_location</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

          <span class="n">set_pid_target</span><span class="p">(</span><span class="n">target_location</span><span class="p">);</span>

        <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
          <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_TARGET_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">target_location</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送目标值</span>
        <span class="cp">#endif</span>
        <span class="p">}</span>

        <span class="cm">/* 扫描KEY4 */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">Key_Scan</span><span class="p">(</span><span class="n">KEY4_GPIO_PORT</span><span class="p">,</span><span class="n">KEY4_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_ON</span>  <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">target_location</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>

          <span class="n">set_pid_target</span><span class="p">(</span><span class="n">target_location</span><span class="p">);</span>

        <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
          <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_TARGET_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">target_location</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送目标值</span>
        <span class="cp">#endif</span>
        <span class="p">}</span>

        <span class="cm">/* 扫描KEY5 */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">Key_Scan</span><span class="p">(</span><span class="n">KEY5_GPIO_PORT</span><span class="p">,</span><span class="n">KEY5_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_ON</span>  <span class="p">)</span>
        <span class="p">{</span>

          <span class="n">target_location</span> <span class="o">*=</span> <span class="mi">-1</span><span class="p">;</span>
          <span class="n">set_pid_target</span><span class="p">(</span><span class="n">target_location</span><span class="p">);</span>

      <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
          <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_TARGET_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">target_location</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送目标值</span>
        <span class="cp">#endif</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>在主函数里面首先做了一些外设的初始化，然后通过按键可以控制电机的启动、停止和目标位置的设定，
在使用上位机的情况下这些操作也可以通过上位机完成。</p>
</div>
<div class="section" id="id5">
<h3><span class="section-number">17.2.3. </span>下载验证1<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id5" title="永久链接至标题">¶</a></h3>
<p>我们按前面介绍的硬件连接好电机和驱动板。</p>
<p>将程序编译下载后，使用Type-C数据线连接开发板到电脑USB，打开野火调试助手-PID调试助手来观察电机的运行效果。
按下KEY1可以启动电机，按下KEY2可以停止电机，按下KEY3可以增加顺时针方向的转动，按下KEY4可以增加逆时针方向的转动。按下按键改变位置后，
我们可以通过上位机来观察速度的变化情况，也可以通过上位机来控制电机。</p>
<img alt="位置环位置式PID控制效果" class="align-center" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/无刷-位置环-位置式运行.png">
</div>
</div>
<div class="section" id="id6">
<h2><span class="section-number">17.3. </span>直流无刷电机位置环控制-增量式PID实现<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="id7">
<h3><span class="section-number">17.3.1. </span>软件设计2<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id7" title="永久链接至标题">¶</a></h3>
<p>通过前面位置式PID控制的学习，大家应该对速度环PID控制有了更深刻的理解，
这里将只讲解核心的部分代码，有些变量的设置，头文件的包含等并没有涉及到，
还有一些在前章节章节分析过的代码在这里也不在重复讲解，完整的代码请参考本节配套的工程。
本章代码在野火电机驱动例程中:\base_code\improve_part\F407\直流无刷电机-速度环控制-增量式PID目录下。</p>
<div class="section" id="id8">
<h4><span class="section-number">17.3.1.1. </span>编程要点2<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id8" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li><p>高级定时器 IO 配置</p></li>
<li><p>定时器时基结构体TIM_HandleTypeDef配置</p></li>
<li><p>定时器输出比较结构体TIM_OC_InitTypeDef配置</p></li>
<li><p>根据电机的换相表编写换相中断回调函数</p></li>
<li><p>根据定时器定义电机控制相关函数.</p></li>
<li><p>配置基本定时器可以产生定时中断来执行PID运算</p></li>
<li><p>编写增量式PID算法</p></li>
<li><p>编写速度控制函数</p></li>
<li><p>增加上位机曲线观察相关代码</p></li>
<li><p>编写按键控制代码</p></li>
</ol>
</div>
</div>
<div class="section" id="id9">
<h3><span class="section-number">17.3.2. </span>软件分析2<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id9" title="永久链接至标题">¶</a></h3>
<p>增量式PID实现的速度环控制和位置式PID现实的速度环控制其控制代码大部分都是一样的，
在上面的编程要点中只有第4项是不同的，其他代码均相同，所以这里将只讲解不一样的部分代码，
完整代码请参考本节配套工程。</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">bsp_pid.c-增量式PID参数初始化</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id26" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">void</span> <span class="nf">PID_param_init</span><span class="p">()</span>
 <span class="p">{</span>
   <span class="cm">/* 初始化参数 */</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">target_val</span><span class="o">=</span><span class="mi">500</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_next</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

   <span class="n">pid</span><span class="p">.</span><span class="n">Kp</span> <span class="o">=</span> <span class="mi">165</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span> <span class="o">=</span> <span class="mi">148</span><span class="p">;</span>

 <span class="cp">#if defined(PID_ASSISTANT_EN)</span>
   <span class="kt">float</span> <span class="n">pid_temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">.</span><span class="n">Kp</span><span class="p">,</span> <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span><span class="p">,</span> <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span><span class="p">};</span>
   <span class="n">set_computer_value</span><span class="p">(</span><span class="n">SEND_P_I_D_CMD</span><span class="p">,</span> <span class="n">CURVES_CH1</span><span class="p">,</span> <span class="n">pid_temp</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>     <span class="c1">// 给通道 1 发送 P I D 值</span>
 <span class="cp">#endif</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>PID_param_init()函数把结构体pid参数初始化，将目标值、实际值、偏差值和上一次偏差值等初始化为0，
其中pid.err用来保存本次偏差值，pid.err_last用来保存上一次偏差值，pid.err_next用来保存上上次的偏差值；
pid.Kp、pid.Ki和pid.Kd是我们配套电机运行效果相对比较好的参数，不同的电机该参数是不同的。
set_computer_value()函数用来同步上位机显示的PID值。</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">bsp_pid.c-增量式PID算法实现</span><a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id27" title="永久链接至代码">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kt">float</span> <span class="nf">PID_realize</span><span class="p">(</span><span class="kt">float</span> <span class="n">temp_val</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="cm">/*计算目标值与实际值的误差*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">target_val</span> <span class="o">-</span> <span class="n">temp_val</span><span class="p">;</span>

   <span class="cm">/*PID算法实现*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span> <span class="o">+=</span> <span class="n">pid</span><span class="p">.</span><span class="n">Kp</span> <span class="o">*</span> <span class="p">(</span><span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">-</span> <span class="n">pid</span><span class="p">.</span><span class="n">err_next</span><span class="p">)</span>
                  <span class="o">+</span>  <span class="n">pid</span><span class="p">.</span><span class="n">Ki</span> <span class="o">*</span>  <span class="n">pid</span><span class="p">.</span><span class="n">err</span>
                  <span class="o">+</span>  <span class="n">pid</span><span class="p">.</span><span class="n">Kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">pid</span><span class="p">.</span><span class="n">err</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pid</span><span class="p">.</span><span class="n">err_next</span> <span class="o">+</span> <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span><span class="p">);</span>
   <span class="cm">/*传递误差*/</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_last</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">err_next</span><span class="p">;</span>
   <span class="n">pid</span><span class="p">.</span><span class="n">err_next</span> <span class="o">=</span> <span class="n">pid</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>

   <span class="cm">/*返回当前实际值*/</span>
   <span class="k">return</span> <span class="n">pid</span><span class="p">.</span><span class="n">actual_val</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>这个函数主要实现了增量式PID算法，用传入的目标值减去实际值得到误差值得到当前偏差值，
在第7~9行中实现了下面公式中的增量式PID算法。</p>
<img alt="../_images/PID_lisan4.png" class="align-center" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/PID_lisan4.png">
<img alt="../_images/PID_lisan6.png" class="align-center" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/PID_lisan6.png">
<p>然后进行误差传递，将本次偏差和上次偏差保存下来，供下次计算时使用。
在第7行中将计算后的结果累加到pid.actual_val变量，最后返回该变量，用于控制电机的PWM占空比。</p>
</div>
<div class="section" id="id10">
<h3><span class="section-number">17.3.3. </span>下载验证2<a class="headerlink" href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_pos_loop_control.html#id10" title="永久链接至标题">¶</a></h3>
<p>我们按前面介绍的硬件连接好电机和驱动板。</p>
<p>将程序编译下载后，使用Type-C数据线连接开发板到电脑USB，打开野火调试助手-PID调试助手来观察电机的运行效果。
按下KEY1可以启动电机，按下KEY2可以停止电机，按下KEY3可以加速，按下KEY4可以减速。按下按键改变速度后，
我们可以通过上位机来观察速度的变化情况，也可以通过上位机来控制电机。下图是电机运行效果图。</p>
<img alt="位置环增量式PID控制效果" class="align-center" src="./17. 无刷电机位置环控制（BLDC） — [野火]电机应用开发实战指南—基于STM32 文档_files/无刷-位置环-增量式运行.png">
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>注意：电机正在运行时应该先停止电机再复位，而不建议直接复位开发板，因为这属于非正常操作，复位的瞬间电机还在继续运动，产生的反电动势有损坏硬件的风险。</p>
</div>
</div>
</div>
</div>


   </div>
   
  </div>
  <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_multi_loop_control.html" class="btn btn-neutral float-right" title="18. 无刷电机双环控制（BLDC）" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="https://doc.embedfire.com/motor/motor_tutorial/zh/latest/improve_part/BLDC_speed_loop_control.html" class="btn btn-neutral float-left" title="16. 无刷电机速度环控制（BLDC）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr>

  <div role="contentinfo">
    <p>
        © Copyright 2020, embedfire-野火 www.embedfire.com
    <br>
      
        <span class="commit">
          Revision <code>fee1432</code>.
        </span>
      
        <span class="lastupdated">
          最后更新于 2022-03-14, 09:55:32 — GMT+08:00 .
        </span>

    <br><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备18017226号-1</a>

    </p>
  </div> 

</footer>

</div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   


<div style="position: static; display: none; width: 0px; height: 0px; border: none; padding: 0px; margin: 0px;"><div id="trans-tooltip"><div id="tip-left-top" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-left-top.png&quot;);"></div><div id="tip-top" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-top.png&quot;) repeat-x;"></div><div id="tip-right-top" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-right-top.png&quot;);"></div><div id="tip-right" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-right.png&quot;) repeat-y;"></div><div id="tip-right-bottom" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-right-bottom.png&quot;);"></div><div id="tip-bottom" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-bottom.png&quot;) repeat-x;"></div><div id="tip-left-bottom" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-left-bottom.png&quot;);"></div><div id="tip-left" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-left.png&quot;);"></div><div id="trans-content"></div></div><div id="tip-arrow-bottom" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-arrow-bottom.png&quot;);"></div><div id="tip-arrow-top" style="background: url(&quot;chrome-extension://jpjgjbbhaifmiigkopmnpbgcgmigaame/imgs/map/tip-arrow-top.png&quot;);"></div></div></body></html>